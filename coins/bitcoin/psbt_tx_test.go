package bitcoin

import (
	"encoding/base64"
	"encoding/hex"
	"github.com/btcsuite/btcd/btcutil"
	"github.com/btcsuite/btcd/chaincfg"
	"github.com/btcsuite/btcd/txscript"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"testing"
)

func TestPsbt(t *testing.T) {
	network := &chaincfg.TestNet3Params
	// seller
	txInput := &TxInput{
		TxId:       "46e3ce050474e6da80760a2a0b062836ff13e2a42962dc1c9b17b8f962444206",
		VOut:       uint32(0),
		Amount:     int64(546),
		Address:    "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	}

	txOutput := &TxOutput{
		Address: "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		Amount:  int64(100000),
	}

	sellerPsbt, err := GenerateSignedListingPSBTBase64(txInput, txOutput, network)
	require.Nil(t, err)
	require.Equal(t, "cHNidP8BAPsCAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAP////8GQkRi+bgXmxzcYimk4hP/NigGCyoKdoDa5nQEBc7jRgAAAAAA/////wMAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctaCGAQAAAAAAF6kU7wVRWgWV0V6vkNn2L7hYc6bYwLSHAAAAAAABASsAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAEBKwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAQErIgIAAAAAAAAiUSC37n+Dpqf9tRMECFbFZ3iqOr6ppFHgybsBLyKnftmbIQEDBIMAAAABE0DyTAGLyV4FHDPkZZysrTZduPOvuvYe4WPj4b8dQZuq62gfaBx1pUWhnUreC5cuImRIAV2cva7hIfQUi1vunScGARcgV7uy1KnLiiNXYz8gG5xRjCeV3taCt5E8a+7z/iO9bS8AAAAA", sellerPsbt)

	// buyer
	var inputs []*TxInput
	inputs = append(inputs, &TxInput{
		TxId:       "25b9d08a26c8d47795301dd47a861cff0459d14f27fbd41cffaca17d9aa20f87",
		VOut:       uint32(0),
		Amount:     int64(249352),
		Address:    "tb1qtsq9c4fje6qsmheql8gajwtrrdrs38kdzeersc",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	})
	inputs = append(inputs, &TxInput{
		TxId:           "6d59aa50447c0d55e6f9535c3e56d7014b4ca8070ee57ce2199219790cfd5815",
		VOut:           uint32(0),
		Amount:         int64(499356),
		Address:        "mouQtmBWDS7JnT65Grj2tPzdSmGKJgRMhE",
		PrivateKey:     "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		NonWitnessUtxo: "02000000010a6b13715c8effde51dac60d572358005a589cd80413a88e0912e4c6d275abbe010000006a473044022019e34aa16cf55eb9c7a8627f61bcd671525a3818a23ab8a78af13c35121ea3c8022055a5bfb3e8486f6e83707660f1fca3da06f140f449902a63900625f43fadf10501210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff019c9e0700000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88ac00000000",
	})
	// seller input
	inputs = append(inputs, txInput)
	inputs = append(inputs, &TxInput{
		TxId:       "d1696c10046ec8b2d938924f1923f1f2e1588095fbf3ea0f8cd640b51da51ba2",
		VOut:       uint32(0),
		Amount:     int64(400),
		Address:    "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	})

	var outputs []*TxOutput
	outputs = append(outputs, &TxOutput{
		Address: "tb1qtsq9c4fje6qsmheql8gajwtrrdrs38kdzeersc",
		Amount:  int64(200000),
	})
	outputs = append(outputs, &TxOutput{
		Address: "mouQtmBWDS7JnT65Grj2tPzdSmGKJgRMhE",
		Amount:  int64(200000),
	})
	// seller output
	outputs = append(outputs, txOutput)
	outputs = append(outputs, &TxOutput{
		Address: "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		Amount:  int64(246500),
	})
	outputs = append(outputs, &TxOutput{
		Address: "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		Amount:  int64(1000),
	})
	outputs = append(outputs, &TxOutput{
		Address: "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		Amount:  int64(1000),
	})

	fee, err := CalcFee(inputs, outputs, sellerPsbt, 2, network)
	require.Nil(t, err)
	require.Equal(t, int64(1204), fee)

	buyerTx, err := GenerateSignedBuyingTx(inputs, outputs, sellerPsbt, network)
	require.Nil(t, err)
	require.Equal(t, "02000000000104870fa29a7da1acff1cd4fb274fd15904ff1c867ad41d309577d4c8268ad0b9250000000000ffffffff1558fd0c79199219e27ce50e07a84c4b01d7563e5c53f9e6550d7c4450aa596d000000006b483045022100bd9b8c17d68efed18f0882bdb77db303a0a547864305e32ed7a9a951b650caa90220131c361e5c27652a3a05603306a87d8f6e117b78fdb1082db23d8960eb6214bf01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff06424462f9b8179b1cdc6229a4e213ff3628060b2a0a7680dae6740405cee3460000000000ffffffffa21ba51db540d68c0feaf3fb958058e1f2f123194f9238d9b2c86e04106c69d100000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffff06400d0300000000001600145c005c5532ce810ddf20f9d1d939631b47089ecd400d0300000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88aca08601000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b487e4c2030000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b2102483045022100a1d12dee8d87d2f8a12ff43f656a6b52183fa5ce4ffd1ab349b978d4dc5e68620220060d8c6d20ea34d3b2f744624d9f027c9020cb80cfb9babe015ebd70db0a927a01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f000140f24c018bc95e051c33e4659cacad365db8f3afbaf61ee163e3e1bf1d419baaeb681f681c75a545a19d4ade0b972e226448015d9cbdaee121f4148b5bee9d270602483045022100bb251cc4a4db4eab3352d54541a03d20d5067e8261b6f7ba8a20a7d955dfafde022078be1dd187ff61934177a9245872f4a90beef32ec40b69f75d9c50c32053d97101210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f00000000", buyerTx)
}

func TestGenerateUnsignedPSBTHex(t *testing.T) {
	network := &chaincfg.TestNet3Params
	var inputs []*TxInput
	inputs = append(inputs, &TxInput{
		TxId:              "46e3ce050474e6da80760a2a0b062836ff13e2a42962dc1c9b17b8f962444206",
		VOut:              uint32(0),
		Sequence:          1,
		Amount:            int64(546),
		Address:           "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		PrivateKey:        "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		MasterFingerprint: 0xF23F9FD2,
		DerivationPath:    "m/44'/0'/0'/0/0",
		PublicKey:         "0357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f",
	})

	var outputs []*TxOutput
	outputs = append(outputs, &TxOutput{
		Address: "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		Amount:  int64(100000),
	})
	psbtHex, err := GenerateUnsignedPSBTHex(inputs, outputs, network)
	require.Nil(t, err)
	require.Equal(t, "70736274ff010053020000000106424462f9b8179b1cdc6229a4e213ff3628060b2a0a7680dae6740405cee34600000000000100008001a08601000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b4870000000000010120220200000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b48701041600145c005c5532ce810ddf20f9d1d939631b47089ecd22060357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f18d29f3ff22c000080000000800000008000000000000000000000", psbtHex)
}

func TestExtractTxFromSignedPSBT(t *testing.T) {
	psbtHex := "70736274ff0100fd90010200000004870fa29a7da1acff1cd4fb274fd15904ff1c867ad41d309577d4c8268ad0b9250000000000ffffffff1558fd0c79199219e27ce50e07a84c4b01d7563e5c53f9e6550d7c4450aa596d0000000000ffffffff06424462f9b8179b1cdc6229a4e213ff3628060b2a0a7680dae6740405cee3460000000000ffffffffa21ba51db540d68c0feaf3fb958058e1f2f123194f9238d9b2c86e04106c69d10000000000ffffffff06400d0300000000001600145c005c5532ce810ddf20f9d1d939631b47089ecd400d0300000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88aca08601000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b487e4c2030000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21000000000001011f08ce0300000000001600145c005c5532ce810ddf20f9d1d939631b47089ecd01086c02483045022100a1d12dee8d87d2f8a12ff43f656a6b52183fa5ce4ffd1ab349b978d4dc5e68620220060d8c6d20ea34d3b2f744624d9f027c9020cb80cfb9babe015ebd70db0a927a01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f000100bf02000000010a6b13715c8effde51dac60d572358005a589cd80413a88e0912e4c6d275abbe010000006a473044022019e34aa16cf55eb9c7a8627f61bcd671525a3818a23ab8a78af13c35121ea3c8022055a5bfb3e8486f6e83707660f1fca3da06f140f449902a63900625f43fadf10501210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff019c9e0700000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88ac0000000001076b483045022100bd9b8c17d68efed18f0882bdb77db303a0a547864305e32ed7a9a951b650caa90220131c361e5c27652a3a05603306a87d8f6e117b78fdb1082db23d8960eb6214bf01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f0001012b2202000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b210108430141f24c018bc95e051c33e4659cacad365db8f3afbaf61ee163e3e1bf1d419baaeb681f681c75a545a19d4ade0b972e226448015d9cbdaee121f4148b5bee9d27068300010120900100000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b4870107171600145c005c5532ce810ddf20f9d1d939631b47089ecd01086c02483045022100bb251cc4a4db4eab3352d54541a03d20d5067e8261b6f7ba8a20a7d955dfafde022078be1dd187ff61934177a9245872f4a90beef32ec40b69f75d9c50c32053d97101210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f00000000000000"
	txHex, err := ExtractTxFromSignedPSBT(psbtHex)
	require.Nil(t, err)
	assert.Equal(t, "02000000000104870fa29a7da1acff1cd4fb274fd15904ff1c867ad41d309577d4c8268ad0b9250000000000ffffffff1558fd0c79199219e27ce50e07a84c4b01d7563e5c53f9e6550d7c4450aa596d000000006b483045022100bd9b8c17d68efed18f0882bdb77db303a0a547864305e32ed7a9a951b650caa90220131c361e5c27652a3a05603306a87d8f6e117b78fdb1082db23d8960eb6214bf01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff06424462f9b8179b1cdc6229a4e213ff3628060b2a0a7680dae6740405cee3460000000000ffffffffa21ba51db540d68c0feaf3fb958058e1f2f123194f9238d9b2c86e04106c69d100000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffff06400d0300000000001600145c005c5532ce810ddf20f9d1d939631b47089ecd400d0300000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88aca08601000000000017a914ef05515a0595d15eaf90d9f62fb85873a6d8c0b487e4c2030000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b2102483045022100a1d12dee8d87d2f8a12ff43f656a6b52183fa5ce4ffd1ab349b978d4dc5e68620220060d8c6d20ea34d3b2f744624d9f027c9020cb80cfb9babe015ebd70db0a927a01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f000141f24c018bc95e051c33e4659cacad365db8f3afbaf61ee163e3e1bf1d419baaeb681f681c75a545a19d4ade0b972e226448015d9cbdaee121f4148b5bee9d27068302483045022100bb251cc4a4db4eab3352d54541a03d20d5067e8261b6f7ba8a20a7d955dfafde022078be1dd187ff61934177a9245872f4a90beef32ec40b69f75d9c50c32053d97101210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f00000000", txHex)
}

func TestSignRawPSBTTransaction(t *testing.T) {
	psbtHex := "70736274ff0100f4020000000300000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000000000000100000000ffffffff0d3236631e07ec2c5873a6a8022d9687d30a55be2a1f09cf6a3cad2273a179fa0000000000ffffffff0300000000000000001976a914000000000000000000000000000000000000000088ac00000000000000001976a914000000000000000000000000000000000000000088ac7427000000000000225120543c99c2989c618e1e9ed5ea99f4e277388da7a5ffccac4ceb8a42448d421161000000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001012b2202000000000000225120543c99c2989c618e1e9ed5ea99f4e277388da7a5ffccac4ceb8a42448d42116101030483000000011720a96e761951f21ed9e609e3815ec3354a865192705f854a57a3ca787668053df800000000"
	res, err := SignRawPSBTTransaction(psbtHex, "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22")
	require.NoError(t, err)
	expected := "70736274ff0100f4020000000300000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000000000000100000000ffffffff0d3236631e07ec2c5873a6a8022d9687d30a55be2a1f09cf6a3cad2273a179fa0000000000ffffffff0300000000000000001976a914000000000000000000000000000000000000000088ac00000000000000001976a914000000000000000000000000000000000000000088ac7427000000000000225120543c99c2989c618e1e9ed5ea99f4e277388da7a5ffccac4ceb8a42448d421161000000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d010304010000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d010304010000000001012b2202000000000000225120543c99c2989c618e1e9ed5ea99f4e277388da7a5ffccac4ceb8a42448d421161010304830000000113403fc7e8825099e83463306cf4476738d89c8aaf42be61cdaf78783dd9c49b02898ffe2e6817f2ff6ceb13b3730448705ccd6630b7954c499afa16eaba486075dc01172057bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f00000000"
	require.Equal(t, expected, res)
}

func TestPayToPubKeyHashScript(t *testing.T) {
	wif, err := btcutil.DecodeWIF("cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22")
	require.NoError(t, err)
	privKey := wif.PrivKey
	require.Equal(t, "0457bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f4f9bb90108ae7f67f9d089de7f8368f953caa440a41f1cf0db562a3695a39939", hex.EncodeToString(privKey.PubKey().SerializeUncompressed()), "pubKey SerializeUncompressed")
	require.Equal(t, "0357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f", hex.EncodeToString(privKey.PubKey().SerializeCompressed()), "pubKey SerializeCompressed")
	pubkeyHash := btcutil.Hash160(privKey.PubKey().SerializeUncompressed())
	pubkeyHashScript, err := txscript.NewScriptBuilder().
		AddOp(txscript.OP_1).
		AddData(pubkeyHash).
		Script()
	require.NoError(t, err)
	require.Equal(t, "URQ7ZCDIAR01pBleHkgFCIt7EmLHbQ==", base64.StdEncoding.EncodeToString(pubkeyHashScript))
}
func TestBatchBuyingTx(t *testing.T) {
	var inputs []*TxInput
	inputs = append(inputs, &TxInput{
		TxId:       "6eac939ba1755162a507d36d14db4aef081da8ab7f8fa2acfdbf815d60905afd",
		VOut:       uint32(1),
		Amount:     int64(816),
		Address:    "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	})
	inputs = append(inputs, &TxInput{
		TxId:       "5a863ab7fad215772dd67575dc1aa1e81828f483a605cb5c75a435773fb620c5",
		VOut:       uint32(1),
		Amount:     int64(816),
		Address:    "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	})
	inputs = append(inputs, &TxInput{
		TxId:       "fc782bc040c49606c667d8e29252595f133729d553596d7265ff871253a81c4e",
		VOut:       uint32(1),
		Amount:     int64(816),
		Address:    "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
		PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
	})
	// seller input
	inputs = append(inputs, &TxInput{
		TxId:    "20600bc40e7c09e2ebe9f7bdd604160e341c11036a06f1c974f7fe87c8acc34c",
		VOut:    uint32(0),
		Amount:  int64(546),
		Address: "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
	})
	inputs = append(inputs, &TxInput{
		TxId:    "c84b0bfc0bf3c469cf066ab15cedf7120cebf28b526b7b9ef4e67e05ac04bad9",
		VOut:    uint32(0),
		Amount:  int64(546),
		Address: "2NF33rckfiQTiE5Guk5ufUdwms8PgmtnEdc",
	})
	inputs = append(inputs, &TxInput{
		TxId:           "01367c13cd59d84c550a8a1bd5e93cadb6a0aa35b247cc2e1648f7c4c48b0889",
		VOut:           uint32(2),
		Amount:         int64(91070),
		Address:        "mouQtmBWDS7JnT65Grj2tPzdSmGKJgRMhE",
		PrivateKey:     "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		NonWitnessUtxo: "020000000001028cfe1307b028d2cec9eeba6f44d345fe47cd2daa719456b600ca95fd186fc60b0300000000ffffffff8cfe1307b028d2cec9eeba6f44d345fe47cd2daa719456b600ca95fd186fc60b010000006b483045022100d1d442b46670aff960be6215cce3dc191f298c17ad28fed78320ef9697743a390220031d876fccd8238b3a71b340ee6f99cc582749105cfb32b02792964fe7a2575301210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff0300350c0000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21a0860100000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88acbe630100000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88ac014030dd053d6bde09830616a49584fac322108a451d7f57742176bdbafb6475a15541123dd49f95fd1a1605b1f01f3f6496b9ed1a609ac2514c62a6a0bd3edd05a10000000000",
	})

	var outputs []*TxOutput
	outputs = append(outputs, &TxOutput{
		Address: "tb1qtsq9c4fje6qsmheql8gajwtrrdrs38kdzeersc",
		Amount:  int64(2448),
	})
	outputs = append(outputs, &TxOutput{
		Address: "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		Amount:  int64(546),
	})
	outputs = append(outputs, &TxOutput{
		Address: "tb1pklh8lqax5l7m2ycypptv2emc4gata2dy28svnwcp9u32wlkenvsspcvhsr",
		Amount:  int64(546),
	})
	// seller output
	outputs = append(outputs, &TxOutput{})
	outputs = append(outputs, &TxOutput{})
	outputs = append(outputs, &TxOutput{
		Address: "mouQtmBWDS7JnT65Grj2tPzdSmGKJgRMhE",
		Amount:  int64(88070),
	})

	sellerPSBTList := []string{
		"cHNidP8BAP0GAQIAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAA/////0zDrMiH/vd0yfEGagMRHDQOFgTWvffp6+IJfA7EC2AgAAAAAAD/////AwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy16AMAAAAAAAAiUSC37n+Dpqf9tRMECFbFZ3iqOr6ppFHgybsBLyKnftmbIQAAAAAAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABASsAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAEBICICAAAAAAAAF6kU7wVRWgWV0V6vkNn2L7hYc6bYwLSHIgIDV7uy1KnLiiNXYz8gG5xRjCeV3taCt5E8a+7z/iO9bS9HMEQCIAddYP5xODEsuAo1ygLHuZeOVV/TN2xNYgZMyRxDIxn9AiAEd+OQVDPYRlfuWVvtwi1zXh1v5Rqmqs0fKABXjZPAMoMBAwSDAAAAAQQWABRcAFxVMs6BDd8g+dHZOWMbRwiezQAAAAA=",
		"cHNidP8BAP0GAQIAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAA/////9m6BKwFfub0nntrUovy6wwS9+1csWoGz2nE8wv8C0vIAAAAAAD/////AwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy16AMAAAAAAAAiUSC37n+Dpqf9tRMECFbFZ3iqOr6ppFHgybsBLyKnftmbIQAAAAAAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABASsAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAEBICICAAAAAAAAF6kU7wVRWgWV0V6vkNn2L7hYc6bYwLSHIgIDV7uy1KnLiiNXYz8gG5xRjCeV3taCt5E8a+7z/iO9bS9HMEQCIFj+0JiCAd2ozwFicnfmCPvjc4Rp3RVAu41CnuD+LK9hAiAFYi869nB2pCikDX9OD5UtfmBfWR1LSuZHMVr4gGLZSYMBAwSDAAAAAQQWABRcAFxVMs6BDd8g+dHZOWMbRwiezQAAAAA=",
	}

	fee, err := CalcFeeForBatchBuy(inputs, outputs, sellerPSBTList, 2, &chaincfg.TestNet3Params)
	require.NoError(t, err)
	require.Equal(t, int64(1700), fee)

	buyerTx, err := GenerateBatchBuyingTx(inputs, outputs, sellerPSBTList, &chaincfg.TestNet3Params)
	require.NoError(t, err)
	expected := "02000000000106fd5a90605d81bffdaca28f7faba81d08ef4adb146dd307a5625175a19b93ac6e01000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffffc520b63f7735a4755ccb05a683f42818e8a11adc7575d62d7715d2fab73a865a01000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffff4e1ca8531287ff65726d5953d52937135f595292e2d867c60696c440c02b78fc01000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffff4cc3acc887fef774c9f1066a03111c340e1604d6bdf7e9ebe2097c0ec40b602000000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffffd9ba04ac057ee6f49e7b6b528bf2eb0c12f7ed5cb16a06cf69c4f30bfc0b4bc800000000171600145c005c5532ce810ddf20f9d1d939631b47089ecdffffffff89088bc4c4f748162ecc47b235aaa0b6ad3ce9d51b8a0a554cd859cd137c3601020000006b483045022100fd51219dccc90a9efb2675733aecf90487fc01855ac8600676c20e3f63e1547c02202640c74750fc9fac3f59b2786697c7d6ba4f65cb5007ba321d0943fb7b206cbd01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2fffffffff0690090000000000001600145c005c5532ce810ddf20f9d1d939631b47089ecd2202000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b212202000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b21e803000000000000225120b7ee7f83a6a7fdb513040856c56778aa3abea9a451e0c9bb012f22a77ed99b2106580100000000001976a9145c005c5532ce810ddf20f9d1d939631b47089ecd88ac0247304402206bbb0dfd4ebe521e2e8f2c3d2fa3b20ae3896c84a0f76a9878634637652baba80220407eaa0c12faf2ad3b1faf263e40529c2d71138cfb9bb9cd6545f9e3422acffe01210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f02473044022052710c9c3a1f868191025fafffc1923ddb9c7d4697bfbf8af550bcb201fa6da402202b048a83a1283948d34aa17ca6dc88606d213e0fe11e73fe07ad294ad50cb72801210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f024730440220209bc7921f4828dd5c688b566eee68bdce3000757b909a6de9b97cd995b594f8022053fc4e9bb9d8418dfe6882487933271f5790a3f7cb2caf4af0cabb1856dc5bc601210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f024730440220075d60fe7138312cb80a35ca02c7b9978e555fd3376c4d62064cc91c432319fd02200477e3905433d84657ee595bedc22d735e1d6fe51aa6aacd1f2800578d93c03283210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f02473044022058fed0988201dda8cf01627277e608fbe3738469dd1540bb8d429ee0fe2caf61022005622f3af67076a428a40d7f4e0f952d7e605f591d4b4ae647315af88062d94983210357bbb2d4a9cb8a2357633f201b9c518c2795ded682b7913c6beef3fe23bd6d2f0000000000"
	require.Equal(t, expected, buyerTx)
}

func TestMPCGenerateUnsignedListingPSBT(t *testing.T) {
	network := &chaincfg.TestNet3Params
	// seller
	txInput := &TxInput{
		TxId:    "167170982fbbd65f11ee0aad09c519c5bf8d49ae81f730d03c3d606b1858abc0",
		VOut:    uint32(3),
		Amount:  int64(1000),
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		//PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		PublicKey: "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50",
	}

	txOutput := &TxOutput{
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		Amount:  int64(546),
	}

	res, err := GenerateMPCUnsignedListingPSBT(txInput, txOutput, network)
	require.NoError(t, err)
	require.Equal(t, "cHNidP8BAPoCAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wMAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctSICAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBKwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABAR/oAwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5AQMEgwAAAAAAAAA=", res.PsbtTx)
	require.Equal(t, 1, len(res.SignHashList))
	require.Equal(t, "235ceb16841300e0e7a94c624920529e2510fe5909bd36fc1db09f40dd2b043a", res.SignHashList[0])
}

func TestMPCGenerateSignedListingPSBT(t *testing.T) {
	listingPsbtB64 := "cHNidP8BAPoCAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wMAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctSICAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBKwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABAR/oAwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5AQMEgwAAAAAAAAA="
	signature := "214d2011c8875dbca1754dda81fccbecd727b46c73e90fefc12004f71142ca9a628f2e5f9f179b7c971934fb7c403d1367298dcb19d082d58f14c24caa48c2b3"
	publicKey := "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50"
	res, err := GenerateMPCSignedListingPSBT(listingPsbtB64, signature, publicKey)
	require.NoError(t, err)
	require.Equal(t, "cHNidP8BAPoCAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wMAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctSICAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBKwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABAR/oAwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5IgIDHPkI53EtehxM7p0YxBMJ+8dQykf95eJqUnBOp/oZalBHMEQCICFNIBHIh128oXVN2oH8y+zXJ7Rsc+kP78EgBPcRQsqaAiBijy5fnxebfJcZNPt8QD0TZymNyxnQgtWPFMJMqkjCs4MBAwSDAAAAAAAAAA==", res.PsbtTx)
}

func TestMPCGenerateUnsignedBuyingPSBT(t *testing.T) {
	network := &chaincfg.TestNet3Params
	// seller
	txInput := &TxInput{
		TxId:    "167170982fbbd65f11ee0aad09c519c5bf8d49ae81f730d03c3d606b1858abc0",
		VOut:    uint32(3),
		Amount:  int64(1000),
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		//PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		PublicKey: "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50",
	}

	txOutput := &TxOutput{
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		Amount:  int64(546),
	}

	sellerPsbt := "cHNidP8BAPoCAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wMAAAAAAAAAACJRIMElTa1AquoSHlPgzsCZhjYvbNQiJ5bRlIyUeRs1KBy1AAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctSICAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBKwAAAAAAAAAAIlEgwSVNrUCq6hIeU+DOwJmGNi9s1CInltGUjJR5GzUoHLUAAQErAAAAAAAAAAAiUSDBJU2tQKrqEh5T4M7AmYY2L2zUIieW0ZSMlHkbNSgctQABAR/oAwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5IgIDHPkI53EtehxM7p0YxBMJ+8dQykf95eJqUnBOp/oZalBHMEQCICFNIBHIh128oXVN2oH8y+zXJ7Rsc+kP78EgBPcRQsqaAiBijy5fnxebfJcZNPt8QD0TZymNyxnQgtWPFMJMqkjCs4MBAwSDAAAAAAAAAA=="

	// buyer
	var inputs []*TxInput
	inputs = append(inputs, &TxInput{
		TxId:    "167170982fbbd65f11ee0aad09c519c5bf8d49ae81f730d03c3d606b1858abc0",
		VOut:    uint32(0),
		Amount:  int64(2000),
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		//PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		PublicKey: "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50",
	})
	inputs = append(inputs, &TxInput{
		TxId:    "167170982fbbd65f11ee0aad09c519c5bf8d49ae81f730d03c3d606b1858abc0",
		VOut:    uint32(1),
		Amount:  int64(2000),
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		//PrivateKey: "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22",
		PublicKey: "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50",
	})

	// seller input
	inputs = append(inputs, txInput)

	var outputs []*TxOutput
	outputs = append(outputs, &TxOutput{
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		Amount:  int64(3000),
	})
	outputs = append(outputs, &TxOutput{
		Address: "tb1qsrx5k69d92avuf4fwke8k35flywd930ems48zf",
		Amount:  int64(1000),
	})
	// seller output
	outputs = append(outputs, txOutput)
	sellList := []string{sellerPsbt}
	res, err := GenerateMPCUnsignedBuyingPSBT(inputs, outputs, sellList, network)
	require.NoError(t, err)
	require.Equal(t, "cHNidP8BAOICAAAAA8CrWBhrYD080DD3ga5Jjb/FGcUJrQruEV/Wuy+YcHEWAAAAAAD/////wKtYGGtgPTzQMPeBrkmNv8UZxQmtCu4RX9a7L5hwcRYBAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wO4CwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX56AMAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+SICAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBH9AHAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkBAwQBAAAAAAEBH9AHAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkBAwQBAAAAAAEBH+gDAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkiAgMc+QjncS16HEzunRjEEwn7x1DKR/3l4mpScE6n+hlqUEcwRAIgIU0gEciHXbyhdU3agfzL7NcntGxz6Q/vwSAE9xFCypoCIGKPLl+fF5t8lxk0+3xAPRNnKY3LGdCC1Y8UwkyqSMKzgwEDBIMAAAAAAAAA", res.PsbtTx)
	require.Equal(t, 2, len(res.SignHashList))
	require.Equal(t, "f01f40ac4777c6949be2c2f9fe145cabe308205cb26d3db5cdb1d504e10d8cd1", res.SignHashList[0])
	require.Equal(t, "92bfdff9f1ff7b7be3c6de5f232e45ebcd9e782a68ac63f9961ed2303e5e5b44", res.SignHashList[1])
}

func TestMPCGenerateSignedBuyingTx(t *testing.T) {
	buyingPsbt64 := "cHNidP8BAMMCAAAAA8CrWBhrYD080DD3ga5Jjb/FGcUJrQruEV/Wuy+YcHEWAAAAAAD/////wKtYGGtgPTzQMPeBrkmNv8UZxQmtCu4RX9a7L5hwcRYBAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wK4CwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5IgIAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QAAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf6AMAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+SICAxz5COdxLXocTO6dGMQTCfvHUMpH/eXialJwTqf6GWpQRzBEAiAhTSARyIddvKF1TdqB/Mvs1ye0bHPpD+/BIAT3EULKmgIgYo8uX58Xm3yXGTT7fEA9E2cpjcsZ0ILVjxTCTKpIwrODAQMEgwAAAAAAAA=="
	signatureList := []string{"6d2db134a25c76ea5dd539a29be37976d4ab8af69372604d9d04c2a3fabe67b61264957608996ca9fbcd50ba339616bf52ab583faade4d6f9c740be4ec72b0c2",
		"30d0cc5dec576d9e7826a630c6bae9728f27d76e239a6a8fe9489d088ffb217e636c00e758c531dd831cb06423f69463727a8191fc7e19ab100bac43f68a3069"}
	publicKey := "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50"
	res, err := GenerateMPCSignedBuyingTx(buyingPsbt64, signatureList, publicKey, 1)
	require.NoError(t, err)
	require.Equal(t, "70736274ff0100c30200000003c0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160000000000ffffffffc0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160100000000ffffffffc0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160300000000ffffffff02b80b00000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9220200000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9000000000001011fd00700000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f901086b0247304402206d2db134a25c76ea5dd539a29be37976d4ab8af69372604d9d04c2a3fabe67b602201264957608996ca9fbcd50ba339616bf52ab583faade4d6f9c740be4ec72b0c20121031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a500001011fd00700000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f901086b02473044022030d0cc5dec576d9e7826a630c6bae9728f27d76e239a6a8fe9489d088ffb217e0220636c00e758c531dd831cb06423f69463727a8191fc7e19ab100bac43f68a30690121031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a500001011fe80300000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f901086b024730440220214d2011c8875dbca1754dda81fccbecd727b46c73e90fefc12004f71142ca9a0220628f2e5f9f179b7c971934fb7c403d1367298dcb19d082d58f14c24caa48c2b38321031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50000000", res.Psbt)
	require.Equal(t, "02000000000103c0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160000000000ffffffffc0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160100000000ffffffffc0ab58186b603d3cd030f781ae498dbfc519c509ad0aee115fd6bb2f987071160300000000ffffffff02b80b00000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9220200000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f90247304402206d2db134a25c76ea5dd539a29be37976d4ab8af69372604d9d04c2a3fabe67b602201264957608996ca9fbcd50ba339616bf52ab583faade4d6f9c740be4ec72b0c20121031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a5002473044022030d0cc5dec576d9e7826a630c6bae9728f27d76e239a6a8fe9489d088ffb217e0220636c00e758c531dd831cb06423f69463727a8191fc7e19ab100bac43f68a30690121031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50024730440220214d2011c8875dbca1754dda81fccbecd727b46c73e90fefc12004f71142ca9a0220628f2e5f9f179b7c971934fb7c403d1367298dcb19d082d58f14c24caa48c2b38321031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a5000000000", res.PsbtTx)
}

func TestGetRandomHash(t *testing.T) {
	h, err := GetRandomHash()
	require.NoError(t, err)
	t.Log(h)
}

func TestGenerateMPCUnsignedPSBT(t *testing.T) {
	publicKey := "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50"
	psbtStr := "cHNidP8BAMMCAAAAA8CrWBhrYD080DD3ga5Jjb/FGcUJrQruEV/Wuy+YcHEWAAAAAAD/////wKtYGGtgPTzQMPeBrkmNv8UZxQmtCu4RX9a7L5hwcRYBAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wK4CwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5IgIAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QAAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf6AMAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+SICAxz5COdxLXocTO6dGMQTCfvHUMpH/eXialJwTqf6GWpQRzBEAiAhTSARyIddvKF1TdqB/Mvs1ye0bHPpD+/BIAT3EULKmgIgYo8uX58Xm3yXGTT7fEA9E2cpjcsZ0ILVjxTCTKpIwrODAQMEgwAAAAAAAA=="
	res, err := GenerateMPCUnsignedPSBT(psbtStr, publicKey)
	require.NoError(t, err)
	require.Equal(t, "cHNidP8BAMMCAAAAA8CrWBhrYD080DD3ga5Jjb/FGcUJrQruEV/Wuy+YcHEWAAAAAAD/////wKtYGGtgPTzQMPeBrkmNv8UZxQmtCu4RX9a7L5hwcRYBAAAAAP/////Aq1gYa2A9PNAw94GuSY2/xRnFCa0K7hFf1rsvmHBxFgMAAAAA/////wK4CwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5IgIAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QAAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf0AcAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+QEDBAEAAAAAAQEf6AMAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+SICAxz5COdxLXocTO6dGMQTCfvHUMpH/eXialJwTqf6GWpQRzBEAiAhTSARyIddvKF1TdqB/Mvs1ye0bHPpD+/BIAT3EULKmgIgYo8uX58Xm3yXGTT7fEA9E2cpjcsZ0ILVjxTCTKpIwrODAQMEgwAAAAAAAA==", res.PsbtTx)
	require.Equal(t, 3, len(res.SignHashList))
	require.Equal(t, "e087eb2cf14ca291f9bc5bcdf26ea09709e18412e0753eca9c495dab10974ddd", res.SignHashList[0])
	require.Equal(t, "ebdddb20b89ff9b84e4f8f35a43f1963020f6405c70d5f98a48246baa49089cd", res.SignHashList[1])
	require.Equal(t, "ae38cd6361dc1c25841a8940b3bd2206db456a5f3b53b0ab8e8cfb76f95824a0", res.SignHashList[2])
}

func TestGenerateMPCSignedPSBT(t *testing.T) {
	psbtStr := "cHNidP8BAOICAAAAA7ouJZmXXTg3kmzK3BFWdAxkRu6DFaniiIDzjqzcuRvNAAAAAAD/////ui4lmZddODeSbMrcEVZ0DGRG7oMVqeKIgPOOrNy5G80BAAAAAP////9IZNf+MyT21UzZ+a05hvwd9GP2OvH13Ej6Wr1RPjxAEgAAAAAA/////wPoAwAAAAAAABYAFIDNS2itKrrOJql1sntGifkc0sX5hAMAAAAAAAAWABSAzUtorSq6ziapdbJ7Ron5HNLF+dwFAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkAAAAAAAEBH+gDAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkBAwQBAAAAAAEBH+gDAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkBAwQBAAAAAAEBH9AHAAAAAAAAFgAUgM1LaK0qus4mqXWye0aJ+RzSxfkiAgMc+QjncS16HEzunRjEEwn7x1DKR/3l4mpScE6n+hlqUEcwRAIgbbGWflByJHPCJ5ZLn9nmVGqw3U/HI0mEjsMCcQAFfWECIGazOhQ19xVL3b+A+CwRlrU4p4OikGNY048K6a6L+JAogwEDBIMAAAAAAAAA"
	signatureList := []string{"4d2b37eac3dc24f33487b9d70a09840f561a3c2b98fcb07ed05e7c6977e2ceae2b8f4eaf6024fa5d932ed3d0b6b805c8e8be07c85906afc83fb2e805c19c0bc3",
		"7f4e3032ed8dc3dcd9cbd7b72633476f8f7890d587b0ab6eb32008118348043e4f4b32e5c7a259bc7758cd100b92214d3e4fa218822f8efeaf9b4a32483711a4", "cd23282fd22d953e17aa41855b7b109f5caf8558683ca5ed1c9b559c1ee4e83337aeaf1353bdd6fb2c1319b2b67dca96b5a4b32540439ca9d6c36dd02aef964b"}
	publicKey := "031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a50"
	res, err := GenerateMPCSignedPSBT(psbtStr, publicKey, signatureList)
	require.NoError(t, err)
	require.Equal(t, "70736274ff0100e20200000003ba2e2599975d3837926ccadc1156740c6446ee8315a9e28880f38eacdcb91bcd0000000000ffffffffba2e2599975d3837926ccadc1156740c6446ee8315a9e28880f38eacdcb91bcd0100000000ffffffff4864d7fe3324f6d54cd9f9ad3986fc1df463f63af1f5dc48fa5abd513e3c40120000000000ffffffff03e80300000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9840300000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9dc0500000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f9000000000001011fe80300000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f92202031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a5047304402204d2b37eac3dc24f33487b9d70a09840f561a3c2b98fcb07ed05e7c6977e2ceae02202b8f4eaf6024fa5d932ed3d0b6b805c8e8be07c85906afc83fb2e805c19c0bc301010304010000000001011fe80300000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f92202031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a5047304402207f4e3032ed8dc3dcd9cbd7b72633476f8f7890d587b0ab6eb32008118348043e02204f4b32e5c7a259bc7758cd100b92214d3e4fa218822f8efeaf9b4a32483711a401010304010000000001011fd00700000000000016001480cd4b68ad2abace26a975b27b4689f91cd2c5f92202031cf908e7712d7a1c4cee9d18c41309fbc750ca47fde5e26a52704ea7fa196a5047304402206db1967e50722473c227964b9fd9e6546ab0dd4fc72349848ec3027100057d61022066b33a1435f7154bddbf80f82c1196b538a783a2906358d38f0ae9ae8bf89028830103048300000000000000", res.PsbtTx)
}

func TestSignPsbtWithKeyPathAndScriptPath(t *testing.T) {
	psbtHex := "70736274ff0100740200000001258fedc4ea8a2945ef64bc4388ab79e8ab8a173894342c2449bfeb3c6bf5b7ea0000000000ffffffff02e8030000000000001976a9142c8826cd93b186b81c1926115e0287efbf23486a88ac401f000000000000160014505049839bc32f869590adc5650c584e17c917fc000000000001012b10270000000000002251203d558197d465de33a5fbc3c2a879e51d5c16a4ae90fcf6aa8f27fb483421f2284215c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0571c2083eaabb20407f08f81edd91590dcf4e9c42d7d69bb82520a5d22a4c3eff120b4b25d72d2d813bee73c679473ddb5f47956ae93e41a3e16b60a7190bccb78afad20a37236e8875b30cad25a3c7df7d07fd09ef29331f8e270ad954f6ba9b42d5bd6ad2057349e985e742d5131e1e2b227b5170f6350ac2e2feb72254fcc25b3cee21a18ac2059d3532148a597a2d05c0395bf5f7176044b1cd312f37701a9b4d0aad70bc5a4ba20a5c60c2188e833d39d0fa798ab3f69aa12ed3dd2f3bad659effa252782de3c31ba20c8ccb03c379e452f10c81232b41a1ca8b63d0baf8387e57d302c987e5abb8527ba20ffeaec52a9b407b355ef6967a7ffc15fd6c3fe07de2844d61550475e7a5233e5ba53a2c001172050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0000000"
	wif := "cPnvkvUYyHcSSS26iD1dkrJdV7k1RoUqJLhn3CYxpo398PdLVE22"
	network := &chaincfg.TestNet3Params
	toSign := &ToSignInput{
		Index:              2,
		Address:            "tb1pyrujq6htc7crmd3uejdkllhk0kctahkfxq75dflnqlg846kgl34qpawucx",
		PublicKey:          "",
		SigHashTypes:       []int{0},
		DisableTweakSigner: false,
	}
	toSignInputs := []*ToSignInput{toSign}
	opt := SignPsbtOption{
		AutoFinalized: false,
		ToSignInputs:  toSignInputs,
	}
	signedPsbt, err := SignPsbtWithKeyPathAndScriptPath(psbtHex, wif, network, &opt)

	require.NoError(t, err)
	require.Equal(t, "70736274ff0100740200000001258fedc4ea8a2945ef64bc4388ab79e8ab8a173894342c2449bfeb3c6bf5b7ea0000000000ffffffff02e8030000000000001976a9142c8826cd93b186b81c1926115e0287efbf23486a88ac401f000000000000160014505049839bc32f869590adc5650c584e17c917fc000000000001012b10270000000000002251203d558197d465de33a5fbc3c2a879e51d5c16a4ae90fcf6aa8f27fb483421f2284215c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0571c2083eaabb20407f08f81edd91590dcf4e9c42d7d69bb82520a5d22a4c3eff120b4b25d72d2d813bee73c679473ddb5f47956ae93e41a3e16b60a7190bccb78afad20a37236e8875b30cad25a3c7df7d07fd09ef29331f8e270ad954f6ba9b42d5bd6ad2057349e985e742d5131e1e2b227b5170f6350ac2e2feb72254fcc25b3cee21a18ac2059d3532148a597a2d05c0395bf5f7176044b1cd312f37701a9b4d0aad70bc5a4ba20a5c60c2188e833d39d0fa798ab3f69aa12ed3dd2f3bad659effa252782de3c31ba20c8ccb03c379e452f10c81232b41a1ca8b63d0baf8387e57d302c987e5abb8527ba20ffeaec52a9b407b355ef6967a7ffc15fd6c3fe07de2844d61550475e7a5233e5ba53a2c001172050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0000000", signedPsbt)
}
